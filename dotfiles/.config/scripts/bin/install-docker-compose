#!/bin/bash
# Install docker compose from source bin from source 

# Set script_dir
script_dir="$(dirname "$(realpath "$0")")"

# Source util function
source "${script_dir}/_util.sh"

ran_col_str "Docker compose install utility" c

# Check requirements
command -v jq >/dev/null || error_msg "Please install jq JSON parsing utility" 1
command -v fzf >/dev/null || error_msg "Please install fzf utility" 1

function fetch_version_docker_compose {
    # Get latest OpenSSL version and print result
    curl -s "https://api.github.com/repos/docker/compose/tags" | \
        # Get all tag names
        jq -r '.[]|.name' | \
        # Get lastest "vx.x.x" pattern without additional characters
        grep -P -m 1 'v[0-9]+\.[0-9]+\.[0-9]+$'
}

# $1 - Docker compose version, otherwise default docker_
if [[ -n "${1}" ]]; then
    # Set a random color
    info_msg "Setting to version to ${UNDERLINE}$1"
    version="${1}"
else
    # Set a random color with style
    info_msg "Fetching latest docker compose tag from GitHub"
    version=$(fetch_version_docker_compose)
    [[ -n ${version} ]] || error_msg "Error fetching version" 1
    info_msg "Setting version to: ${UNDERLINE}${version}"
fi

docker_url="https://github.com/docker/compose/releases/download/${version}/docker-compose-$(uname -s)-$(uname -m)"
[[ $(check_url "$docker_url") -ne 0 ]] && error_msg "Bad url" 6
success_msg "Valid url: ${UNDERLINE}${docker_url}"

sudo curl -L $docker_url -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
success_msg "Docker Dompose installed"
docker-compose --version

